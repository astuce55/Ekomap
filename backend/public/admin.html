<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EkoMap - Admin Terminal</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --accent-green: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            line-height: 1.5;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 span { color: var(--accent-green); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid #334155;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-card .number {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* Controls Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            background: #1e293b;
            padding: 0.4rem;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--accent-green);
            color: #000;
        }

        .filter-btn:not(.active):hover {
            background: #334155;
            color: var(--text-main);
        }

        /* Incidents Grid */
        .incidents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .incident-card {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid #334155;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .incident-photo-wrapper {
            position: relative;
            height: 220px;
            overflow: hidden;
        }

        .incident-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .incident-card:hover .incident-photo {
            transform: scale(1.05);
        }

        .incident-info {
            padding: 1.5rem;
        }

        .badges {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .type-accident { background: rgba(239, 68, 68, 0.15); color: #f87171; }
        .type-danger { background: rgba(245, 158, 11, 0.15); color: #fbbf24; }
        .type-travaux { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        
        .status-badge {
            border: 1px solid currentColor;
            background: transparent;
        }

        .incident-details {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .incident-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .btn-verify {
            background: var(--accent-green);
            color: #064e3b;
        }

        .btn-verify:hover { background: #34d399; transform: translateY(-2px); }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-delete:hover { background: #ef4444; color: white; }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 100px;
            color: var(--text-muted);
        }

        @media (max-width: 640px) {
            .container { padding: 1rem; }
            .section-header { flex-direction: column; align-items: stretch; }
            .filter-buttons { overflow-x: auto; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>üåç EkoMap <span>Admin</span></h1>
            <div id="live-indicator" style="font-size: 0.8rem; color: var(--accent-green);">
                ‚óè LIVE MONITORING
            </div>
        </div>
    </header>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>TOTAL SIGNALEMENTS</h3>
                <div class="number" id="totalCount">-</div>
            </div>
            <div class="stat-card">
                <h3>EN ATTENTE</h3>
                <div class="number" id="pendingCount" style="color: var(--warning)">-</div>
            </div>
            <div class="stat-card">
                <h3>V√âRIFI√âS</h3>
                <div class="number" id="verifiedCount" style="color: var(--accent-green)">-</div>
            </div>
            <div class="stat-card">
                <h3>AUJOURD'HUI</h3>
                <div class="number" id="todayCount">-</div>
            </div>
        </div>

        <div class="section-header">
            <h2>Flux d'incidents</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="pending">Attente</button>
                <button class="filter-btn" data-filter="verified">V√©rifi√©s</button>
                <button class="filter-btn" data-filter="accident">Accidents</button>
            </div>
        </div>

        <div id="incidentsList" class="incidents-grid">
            <div class="loading">Initialisation du syst√®me...</div>
        </div>
    </div>

    <script>
        // --- Garder la m√™me logique JS que ton fichier original ---
        const API_URL = 'http://localhost:3000/api';
        let allIncidents = [];
        let currentFilter = 'all';

        async function loadData() {
            try {
                const incidentsRes = await fetch(`${API_URL}/incidents`);
                const incidentsData = await incidentsRes.json();
                allIncidents = incidentsData.data || [];

                const statsRes = await fetch(`${API_URL}/stats`);
                const statsData = await statsRes.json();

                updateStats(statsData.data);
                displayIncidents();
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('incidentsList').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; background: #450a0a; border: 1px solid #991b1b; padding: 2rem; border-radius: 12px; color: #fecaca;">
                        <h3>Impossible de joindre le serveur</h3>
                        <p style="margin-top: 10px; opacity: 0.8;">V√©rifiez que l'API est lanc√©e sur le port 3000</p>
                    </div>
                `;
            }
        }

        function updateStats(stats) {
            document.getElementById('totalCount').textContent = stats.total || 0;
            const pending = stats.byStatus.find(s => s._id === 'pending');
            document.getElementById('pendingCount').textContent = pending ? pending.count : 0;
            const verified = stats.byStatus.find(s => s._id === 'verified');
            document.getElementById('verifiedCount').textContent = verified ? verified.count : 0;
            const today = new Date().toISOString().split('T')[0];
            const todayData = stats.byDay.find(d => d._id === today);
            document.getElementById('todayCount').textContent = todayData ? todayData.count : 0;
        }

        function displayIncidents() {
            const container = document.getElementById('incidentsList');
            let filtered = allIncidents;
            
            if (currentFilter !== 'all') {
                if (currentFilter === 'pending' || currentFilter === 'verified') {
                    filtered = allIncidents.filter(i => i.status === currentFilter);
                } else {
                    filtered = allIncidents.filter(i => i.type === currentFilter);
                }
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div class="loading">Aucun incident trouv√©.</div>`;
                return;
            }

            container.innerHTML = filtered.map(incident => `
                <div class="incident-card">
                    <div class="incident-photo-wrapper">
                        <img src="${API_URL.replace('/api', '')}${incident.photo_url}" 
                             alt="Incident" 
                             class="incident-photo"
                             onerror="this.src='https://images.unsplash.com/photo-1584931423298-c576fda54bd2?q=80&w=500&auto=format&fit=crop'">
                    </div>
                    <div class="incident-info">
                        <div class="badges">
                            <span class="badge type-${incident.type}">${getTypeName(incident.type)}</span>
                            <span class="badge status-badge">${incident.status}</span>
                        </div>
                        
                        <div class="incident-details">
                            <span>üìç</span> 
                            <span>${incident.coordinates.lat.toFixed(4)}, ${incident.coordinates.lng.toFixed(4)}</span>
                        </div>
                        <div class="incident-details">
                            <span>üïí</span> 
                            <span>${new Date(incident.reported_at).toLocaleString('fr-FR', {hour: '2-digit', minute:'2-digit', day:'2-digit', month:'short'})}</span>
                        </div>
                        <div class="incident-details">
                            <span>üë§</span> 
                            <span>${incident.is_guest ? 'Anonyme' : `Utilisateur #${incident.user_id}`}</span>
                        </div>

                        <div class="incident-actions">
                            ${incident.status !== 'verified' ? `
                                <button class="btn btn-verify" onclick="verifyIncident('${incident._id}')">
                                    V√©rifier
                                </button>
                            ` : ''}
                            <button class="btn btn-delete" onclick="deleteIncident('${incident._id}')">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getTypeName(type) {
            const names = { 'accident': 'Accident', 'danger': 'Risque', 'travaux': 'Travaux', 'controle': 'Contr√¥le' };
            return names[type] || type;
        }

        async function verifyIncident(id) {
            const res = await fetch(`${API_URL}/incidents/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'verified' })
            });
            if (res.ok) loadData();
        }

        async function deleteIncident(id) {
            if (!confirm('Supprimer d√©finitivement ?')) return;
            const res = await fetch(`${API_URL}/incidents/${id}`, { method: 'DELETE' });
            if (res.ok) loadData();
        }

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                displayIncidents();
            });
        });

        setInterval(loadData, 30000);
        loadData();
    </script>
</body>
</html>